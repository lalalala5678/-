<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µåŠ›è½¦æ™ºèƒ½è°ƒåº¦ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --panel-bg: rgba(30, 30, 46, 0.95);
            --text-color: #e0e0e0;
            --accent-color: #00d2ff;
            --success-color: #00ff88;
            --danger-color: #ff4757;
            --border-color: #3f3f4f;
        }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-color); overflow: hidden; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        /* Main Dashboard Container */
        #dashboard-container {
            display: flex;
            width: 95vw; /* Use viewport width */
            height: 95vh; /* Use viewport height */
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
            overflow: hidden;
        }

        /* Floating Sidebar - now integrated into dashboard layout */
        #sidebar {
            flex: 0 0 350px; /* Fixed width for sidebar */
            max-height: 100%;
            background: var(--panel-bg);
            /* backdrop-filter: blur(10px); */ /* Removed for solid integration */
            padding: 25px;
            border-right: 1px solid var(--border-color); /* Separator */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) var(--panel-bg);
            border-top-left-radius: 15px; /* Match container */
            border-bottom-left-radius: 15px;
        }

        /* Map Container - now a component within the dashboard */
        #map {
            flex-grow: 1; /* Takes remaining space */
            height: 100%;
            border-top-right-radius: 15px; /* Match container */
            border-bottom-right-radius: 15px;
            z-index: 1; /* Below sidebar */
        }
        
        /* Scrollbar */
        #sidebar::-webkit-scrollbar { width: 6px; }
        #sidebar::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 3px; }
        
        h3 { margin: 0 0 5px 0; font-size: 1.4em; color: var(--accent-color); text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; display: inline-block;}
        h4 { margin: 10px 0 10px 0; font-size: 1.0em; color: #aab; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        h4::before { content: ''; display: block; width: 4px; height: 14px; background: var(--accent-color); border-radius: 2px; }

        .control-group { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }

        /* Inputs & Selects */
        input[type="number"], select {
            width: 100%; padding: 10px; margin-top: 8px; box-sizing: border-box;
            background: rgba(0,0,0,0.3); border: 1px solid var(--border-color);
            color: white; border-radius: 4px; font-family: monospace; font-size: 1em;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus, select:focus { outline: none; border-color: var(--accent-color); }

        /* Buttons */
        button {
            width: 100%; padding: 10px 15px; margin-top: 10px; cursor: pointer;
            background: transparent; color: var(--accent-color);
            border: 1px solid var(--accent-color); border-radius: 4px;
            font-size: 0.9em; font-weight: 600; letter-spacing: 0.5px;
            transition: all 0.3s ease; text-transform: uppercase;
        }
        button:hover { background: var(--accent-color); color: #1e1e2e; box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        
        button.secondary { color: #bbb; border-color: #777; }
        button.secondary:hover { background: #777; color: white; box-shadow: none; }
        
        button.danger { color: var(--danger-color); border-color: var(--danger-color); }
        button.danger:hover { background: var(--danger-color); color: white; box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }
        
        /* Toggle Button Active State */
        button.active-mode { background: var(--success-color); border-color: var(--success-color); color: #1e1e2e; box-shadow: 0 0 15px rgba(0, 255, 136, 0.4); }

        /* Labels & Checkboxes */
        label { display: block; font-size: 0.9em; color: #ccc; margin-top: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        input[type="checkbox"] { accent-color: var(--accent-color); width: 16px; height: 16px; cursor: pointer; }

        /* Status Log */
        .status { font-size: 0.85em; color: #889; margin-top: 8px; }
        #log {
            background: #111; color: #0f0; font-family: 'Courier New', monospace;
            padding: 10px; border: 1px solid #333; border-radius: 4px;
            height: 120px; overflow-y: auto; font-size: 0.8em;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        
        /* Leaflet Overrides */
        .leaflet-popup-content-wrapper { background: rgba(30, 30, 46, 0.9); color: white; backdrop-filter: blur(5px); border-radius: 8px; }
        .leaflet-popup-tip { background: rgba(30, 30, 46, 0.9); }
    </style>
</head>
<body>

<div id="dashboard-container">
    <div id="sidebar">
        <h3>æ§åˆ¶é¢æ¿</h3>
        
        <div class="control-group">
            <h4>1. åœè½¦ç‚¹ç®¡ç†</h4>
            <button id="toggle-spot-mode-btn">ç‚¹å‡»åœ°å›¾è®¾å®šåœè½¦ç‚¹: å…³</button>
            <button id="clear-spots-btn" class="danger">æ¸…ç©ºåœè½¦ç‚¹</button>
            <div id="spot-count" class="status">å½“å‰åœè½¦ç‚¹: 0</div>
        </div>

        <div class="control-group">
            <h4>2. ç”µåŠ›è½¦ç®¡ç†</h4>
            <label>æ·»åŠ æ•°é‡: <input type="number" id="vehicle-count-input" value="1" min="1"></label>
            <label>ç”µåŠ›è½½è·: <input type="number" id="vehicle-capacity-input" value="100" min="10"></label>
            <button id="add-vehicle-btn">æ·»åŠ ç”µåŠ›è½¦</button>
            <button id="clear-vehicles-btn" class="danger">æ¸…ç©ºç”µåŠ›è½¦</button>
            <div id="vehicle-status" class="status">è½¦è¾†: 0 (æœªè°ƒåº¦)</div>
        </div>

        <div class="control-group">
            <h4>3. æ–­ç”µæ¨¡æ‹Ÿ</h4>
            <button id="gen-outage-btn">ç”Ÿæˆæ–­ç”µæ¦‚ç‡çƒ­åŠ›å›¾</button>
            <label><input type="checkbox" id="show-outage-check" checked> æ˜¾ç¤ºæ–­ç”µçƒ­åŠ›å›¾</label>
        </div>

        <div class="control-group">
            <h4>4. æ™ºèƒ½è°ƒåº¦</h4>
            <label>ç®—æ³•æ¨¡å¼:</label>
            <select id="algo-mode" style="width:100%; padding: 5px;">
                <option value="linear">è´ªå¿ƒ + ç›´çº¿è·ç¦» (å¿«)</option>
                <option value="api" disabled>è´ªå¿ƒ + APIè·¯å¾„ (æš‚æœªå¼€æ”¾)</option>
            </select>
            <button id="optimize-btn">å¼€å§‹è®¡ç®—è°ƒåº¦</button>
            <label><input type="checkbox" id="show-support-check" checked> æ˜¾ç¤ºæ”¯æ´çƒ­åŠ›å›¾</label>
        </div>
        
        <div id="log" class="status" style="white-space: pre-wrap; height: 100px; overflow-y: auto; border: 1px solid #ccc; padding: 5px;"></div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    const map = L.map('map').setView([38.0428, 114.5149], 12);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Layers
    const spotLayer = L.layerGroup().addTo(map);
    let outageHeatLayer = null;
    let supportHeatLayer = null;

    // State
    let isSpotMode = false;
    let parkingSpots = [];
    let vehicles = [];

    // UI Elements
    const toggleSpotBtn = document.getElementById('toggle-spot-mode-btn');
    const spotCountEl = document.getElementById('spot-count');
    const vehicleStatusEl = document.getElementById('vehicle-status');
    const logEl = document.getElementById('log');

    function log(msg) {
        logEl.innerText += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- 1. Parking Spots ---
    
    toggleSpotBtn.addEventListener('click', () => {
        isSpotMode = !isSpotMode;
        toggleSpotBtn.innerText = `ç‚¹å‡»åœ°å›¾è®¾å®šåœè½¦ç‚¹: ${isSpotMode ? 'å¼€' : 'å…³'}`;
        // Toggle CSS class for tech style
        if (isSpotMode) {
            toggleSpotBtn.classList.add('active-mode');
        } else {
            toggleSpotBtn.classList.remove('active-mode');
        }
    });

    map.on('click', (e) => {
        if (isSpotMode) {
            addParkingSpot(e.latlng);
        }
    });

    function addParkingSpot(latlng) {
        fetch('/api/spots', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({lat: latlng.lat, lng: latlng.lng})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                parkingSpots.push(data.spot);
                renderSpot(data.spot);
                updateSpotCount();
                log(`å·²æ·»åŠ åœè½¦ç‚¹ #${data.spot.id}`);
            }
        });
    }
    
    function renderSpot(spot) {
        // Check if this spot matches an existing layer to update it, or create new
        // For simplicity, we clear and redraw all spots when assignments change, 
        // OR we just keep the marker reference and update popup.
        // Let's store marker reference in spot object for easy update.
        
        const icon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style='background-color:blue; width:12px; height:12px; border-radius:50%; border:2px solid white;'></div>`,
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });
        
        const marker = L.marker([spot.lat, spot.lng], {icon: icon})
            .addTo(spotLayer);
            
        spot.marker = marker; // Store ref
        updateSpotPopup(spot, []); // Initial empty state
    }

    function updateSpotPopup(spot, assignedVehicles) {
        let content = `<b>åœè½¦ç‚¹ #${spot.id}</b><br>`;
        if (assignedVehicles.length === 0) {
            content += `<span style="color:gray">æš‚æ— è½¦è¾†åœæ”¾</span>`;
            // Reset icon to default if needed
            spot.marker.setIcon(L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:blue; width:12px; height:12px; border-radius:50%; border:2px solid white;'></div>`,
                iconSize: [12, 12], iconAnchor: [6, 6]
            }));
        } else {
            content += `<b>å½“å‰åœæ”¾: ${assignedVehicles.length} è¾†</b><hr style="margin:5px 0">`;
            let totalCap = 0;
            content += `<div style="max-height:100px; overflow-y:auto; font-size:0.9em">`;
            assignedVehicles.forEach(v => {
                content += `ğŸš— è½¦è¾† #${v.id} (è½½è·: ${v.capacity})<br>`;
                totalCap += v.capacity;
            });
            content += `</div>`;
            content += `<hr style="margin:5px 0"><b>æ€»æ”¯æ´èƒ½åŠ›: ${totalCap}</b>`;
            
            // Highlight marker
            spot.marker.setIcon(L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:#28a745; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px black;'></div>`,
                iconSize: [16, 16], iconAnchor: [8, 8]
            }));
        }
        spot.marker.bindPopup(content);
    }

    function updateSpotCount() {
        spotCountEl.innerText = `å½“å‰åœè½¦ç‚¹: ${parkingSpots.length}`;
    }

    document.getElementById('clear-spots-btn').addEventListener('click', () => {
        fetch('/api/spots/clear', {method: 'POST'})
        .then(res => res.json())
        .then(() => {
            parkingSpots = [];
            spotLayer.clearLayers();
            updateSpotCount();
            log('åœè½¦ç‚¹å·²æ¸…ç©º');
        });
    });

    // --- 2. Vehicles ---

    document.getElementById('add-vehicle-btn').addEventListener('click', () => {
        const count = document.getElementById('vehicle-count-input').value;
        const capacity = document.getElementById('vehicle-capacity-input').value;
        
        fetch('/api/vehicles', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({count: count, capacity: capacity})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                data.vehicles.forEach(v => vehicles.push(v));
                updateVehicleStatus();
                log(`å·²æ·»åŠ  ${count} è¾†è½¦ (è½½è· ${capacity})`);
            }
        });
    });

    document.getElementById('clear-vehicles-btn').addEventListener('click', () => {
        fetch('/api/vehicles/clear', {method: 'POST'})
        .then(res => res.json())
        .then(() => {
            vehicles = [];
            updateVehicleStatus();
            log('è½¦è¾†å·²æ¸…ç©º');
        });
    });

    function updateVehicleStatus() {
        vehicleStatusEl.innerText = `è½¦è¾†: ${vehicles.length} (æœªè°ƒåº¦)`;
    }

    // --- 3. Outage Heatmap ---

    document.getElementById('gen-outage-btn').addEventListener('click', () => {
        log("æ­£åœ¨ç”Ÿæˆæ–­ç”µæ¨¡æ‹Ÿæ•°æ®...");
        fetch('/api/heatmap/outage/generate', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                drawOutageHeatmap(data.data);
                log("æ–­ç”µæ¦‚ç‡çƒ­åŠ›å›¾å·²æ›´æ–°");
            }
        });
    });

    function drawOutageHeatmap(points) {
        if (outageHeatLayer) map.removeLayer(outageHeatLayer);
        // Format: [lat, lng, intensity]
        // max: 1.5 allows some accumulation before turning red.
        outageHeatLayer = L.heatLayer(points, {
            radius: 35, 
            blur: 25, 
            max: 1.0, 
            maxZoom: 13, 
            gradient: {0.2: 'blue', 0.5: 'lime', 1: 'red'}
        });
        
        if(document.getElementById('show-outage-check').checked) {
            outageHeatLayer.addTo(map);
        }
    }

    document.getElementById('show-outage-check').addEventListener('change', (e) => {
        if(!outageHeatLayer) return;
        if(e.target.checked) map.addLayer(outageHeatLayer);
        else map.removeLayer(outageHeatLayer);
    });

    // --- 4. Optimization ---

    document.getElementById('optimize-btn').addEventListener('click', () => {
        if(parkingSpots.length === 0) { alert("è¯·å…ˆè®¾å®šåœè½¦ç‚¹"); return; }
        if(vehicles.length === 0) { alert("è¯·å…ˆæ·»åŠ ç”µåŠ›è½¦"); return; }

        log("æ­£åœ¨è®¡ç®—æœ€ä¼˜è°ƒåº¦æ–¹æ¡ˆ...");
        const mode = document.getElementById('algo-mode').value;
        
        fetch('/api/optimize', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: mode})
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                log("è°ƒåº¦è®¡ç®—å®Œæˆ!");
                applyAssignments(data.assignments);
                loadSupportHeatmap();
            } else {
                log("é”™è¯¯: " + data.error);
            }
        });
    });

    function applyAssignments(assignments) {
        // assignments: {vehicle_id: spot_id, ...}
        let assignedCount = Object.keys(assignments).length;
        vehicleStatusEl.innerText = `è½¦è¾†: ${vehicles.length} (å·²è°ƒåº¦ ${assignedCount})`;
        
        // Group vehicles by spot
        const spotVehicles = {}; // spot_id -> [vehicle_obj, ...]
        
        // Initialize for all spots
        parkingSpots.forEach(s => spotVehicles[s.id] = []);
        
        // Fill with assignment data
        vehicles.forEach(v => {
            if (assignments[v.id] !== undefined) {
                const spotId = assignments[v.id];
                if (spotVehicles[spotId]) {
                    spotVehicles[spotId].push(v);
                }
            }
        });
        
        // Update all spot markers
        let spotsWithCars = 0;
        parkingSpots.forEach(spot => {
            const vs = spotVehicles[spot.id] || [];
            updateSpotPopup(spot, vs);
            if (vs.length > 0) spotsWithCars++;
        });
        
        // Show simple summary
        log(`è°ƒåº¦å®Œæˆ: ${assignedCount} è¾†è½¦å·²åˆ†é…åˆ° ${spotsWithCars} ä¸ªåœè½¦ç‚¹`);
    }

    function loadSupportHeatmap() {
        fetch('/api/heatmap/support')
        .then(res => res.json())
        .then(data => {
            drawSupportHeatmap(data.data);
        });
    }

    function drawSupportHeatmap(points) {
        if (supportHeatLayer) map.removeLayer(supportHeatLayer);
        // Different color gradient for support (e.g., Yellow/Orange)
        supportHeatLayer = L.heatLayer(points, {
            radius: 40, 
            blur: 30, 
            max: 1.0, 
            maxZoom: 13, 
            gradient: {0.2: 'cyan', 0.5: 'yellow', 1: 'orange'}
        });
        
        if(document.getElementById('show-support-check').checked) {
            supportHeatLayer.addTo(map);
        }
    }
    
    document.getElementById('show-support-check').addEventListener('change', (e) => {
        if(!supportHeatLayer) return;
        if(e.target.checked) map.addLayer(supportHeatLayer);
        else map.removeLayer(supportHeatLayer);
    });

</script>
</body>
</html>